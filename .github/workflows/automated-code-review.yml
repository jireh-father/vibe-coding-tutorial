name: ìë™ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - '**.py'
      - '**.js'
      - '**.jsx'
      - '**.ts'
      - '**.tsx'
      - '**.css'
      - '**.html'

jobs:
  code-quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pylint
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: Flake8 ì‹¤í–‰
        run: |
          flake8 src frontend tests --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true
          
      - name: Pylint ì‹¤í–‰
        id: pylint
        run: |
          pylint --output-format=text --disable=C0111,R0903 --fail-under=7.0 src frontend tests > pylint_results.txt || true
          cat pylint_results.txt
          echo "score=$(grep -oP '(?<=rated at ).*(?=/10)' pylint_results.txt || echo '0.0')" >> $GITHUB_OUTPUT
          
      - name: Black ê²€ì‚¬
        id: black
        run: |
          black --check --diff src frontend tests > black_results.txt || true
          cat black_results.txt
          
      - name: ì½”ë“œ ë¦¬ë·° ì½”ë©˜íŠ¸ ì‘ì„±
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo;
            
            // Pylint ê²°ê³¼ ì½ê¸°
            let pylintScore = '${{ steps.pylint.outputs.score }}';
            if (!pylintScore) pylintScore = '0.0';
            
            let pylintEmoji = '';
            if (parseFloat(pylintScore) >= 9.0) {
              pylintEmoji = 'ğŸŸ¢';
            } else if (parseFloat(pylintScore) >= 7.0) {
              pylintEmoji = 'ğŸŸ¡';
            } else {
              pylintEmoji = 'ğŸ”´';
            }
            
            // Black ê²°ê³¼ ì½ê¸°
            let blackResults = '';
            try {
              blackResults = fs.readFileSync('black_results.txt', 'utf8').trim();
            } catch (error) {
              blackResults = 'Black ê²°ê³¼ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            const hasBlackIssues = blackResults.includes('would reformat');
            const blackEmoji = hasBlackIssues ? 'ğŸ”´' : 'ğŸŸ¢';
            
            // Flake8 ê²°ê³¼ëŠ” ì—ëŸ¬ê°€ ìˆì„ ê²½ìš°ë§Œ í‘œì‹œ
            
            // ì½”ë“œ ë³€ê²½ ë¶„ì„
            const response = await github.rest.pulls.listFiles({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber
            });
            
            const files = response.data;
            
            // ë³µì¡ë„ ì¸¡ì • (ì„ì‹œ ì§€í‘œ: íŒŒì¼ë‹¹ ë³€ê²½ ì¤„ ìˆ˜)
            const avgChangesPerFile = files.reduce((acc, file) => acc + file.additions + file.deletions, 0) / files.length;
            
            // ì½”ë“œ í’ˆì§ˆ ì¢…í•© ì ìˆ˜ (10ì  ë§Œì , ì„ì‹œ ì‚°ì¶œì‹)
            const qualityScore = Math.min(10, Math.max(0, parseFloat(pylintScore) * 0.7 + (hasBlackIssues ? 0 : 3)));
            
            // ì½”ë“œ ë¦¬ë·° ìƒì„±
            const comment = `## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼
            
            ### ì½”ë“œ í’ˆì§ˆ ë¶„ì„
            
            | ê²€ì‚¬ ë„êµ¬ | ê²°ê³¼ | ì ìˆ˜ |
            | --------- | ---- | ---- |
            | Pylint | ${pylintEmoji} | ${pylintScore}/10 |
            | Black í¬ë§·íŒ… | ${blackEmoji} | ${hasBlackIssues ? 'í¬ë§·íŒ… í•„ìš”' : 'í†µê³¼'} |
            | ì½”ë“œ ë³µì¡ë„ | ${avgChangesPerFile > 100 ? 'ğŸ”´' : avgChangesPerFile > 50 ? 'ğŸŸ¡' : 'ğŸŸ¢'} | í‰ê·  ${Math.round(avgChangesPerFile)}ì¤„/íŒŒì¼ |
            | **ì¢…í•© ì ìˆ˜** | ${qualityScore >= 8 ? 'ğŸŸ¢' : qualityScore >= 6 ? 'ğŸŸ¡' : 'ğŸ”´'} | **${qualityScore.toFixed(1)}/10** |
            
            ### ê°œì„  ì œì•ˆ
            
            ${parseFloat(pylintScore) < 7.0 ? '- Pylint ì ìˆ˜ê°€ ë‚®ìŠµë‹ˆë‹¤. ì½”ë“œ í’ˆì§ˆì„ ê°œì„ í•´ ì£¼ì„¸ìš”.\n' : ''}
            ${hasBlackIssues ? '- Black í¬ë§·íŒ… ê·œì¹™ì„ ë”°ë¥´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. `black` ì‹¤í–‰ì„ í†µí•´ ì½”ë“œ í¬ë§·ì„ ì •ë¦¬í•´ ì£¼ì„¸ìš”.\n' : ''}
            ${avgChangesPerFile > 100 ? '- íŒŒì¼ë‹¹ ë³€ê²½ ì‚¬í•­ì´ ë§ìŠµë‹ˆë‹¤. ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.\n' : ''}
            
            ### ì½”ë“œ ìŠ¤íƒ€ì¼ ê°€ì´ë“œ
            - í•¨ìˆ˜ì™€ í´ë˜ìŠ¤ì— ì ì ˆí•œ ë¬¸ì„œí™”(docstring) ì¶”ê°€
            - ë³€ìˆ˜ëª…ê³¼ í•¨ìˆ˜ëª…ì€ ì˜ë¯¸ë¥¼ ëª…í™•íˆ í‘œí˜„
            - í•œ í•¨ìˆ˜ëŠ” í•œ ê°€ì§€ ì‘ì—…ë§Œ ìˆ˜í–‰í•˜ë„ë¡ êµ¬ì„±
            - ë°˜ë³µë˜ëŠ” ì½”ë“œëŠ” í•¨ìˆ˜ë¡œ ì¶”ì¶œí•˜ì—¬ ì¬ì‚¬ìš©
            
            > ì´ ì½”ë“œ ë¦¬ë·°ëŠ” ìë™í™” ë„êµ¬ë¥¼ í†µí•´ ìƒì„±ë˜ì—ˆìœ¼ë©°, ì‹¤ì œ ì½”ë“œ í’ˆì§ˆê³¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: comment
            });

  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
          
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
          
      - name: Bandit ë³´ì•ˆ ê²€ì‚¬
        id: bandit
        run: |
          bandit -r src frontend -f txt -o bandit_results.txt || true
          cat bandit_results.txt
          
      - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
        id: safety
        run: |
          safety check -r requirements.txt --json > safety_results.json || true
          cat safety_results.json
          
      - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo;
            
            // Bandit ê²°ê³¼ ì½ê¸°
            let banditResults = '';
            let banditIssues = 0;
            try {
              banditResults = fs.readFileSync('bandit_results.txt', 'utf8').trim();
              const issuesMatch = banditResults.match(/Found (\d+) issues/);
              if (issuesMatch) {
                banditIssues = parseInt(issuesMatch[1]);
              }
            } catch (error) {
              banditResults = 'Bandit ê²°ê³¼ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            // Safety ê²°ê³¼ ì½ê¸°
            let safetyIssues = 0;
            try {
              const safetyData = fs.readFileSync('safety_results.json', 'utf8').trim();
              if (safetyData) {
                try {
                  const safetyJson = JSON.parse(safetyData);
                  if (safetyJson && Array.isArray(safetyJson.vulnerabilities)) {
                    safetyIssues = safetyJson.vulnerabilities.length;
                  }
                } catch (e) {
                  console.error('Safety JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                }
              }
            } catch (error) {
              console.error('Safety ê²°ê³¼ ì½ê¸° ì˜¤ë¥˜:', error);
            }
            
            // ë³´ì•ˆ ì ìˆ˜ ê³„ì‚° (10ì  ë§Œì )
            const securityScore = Math.max(0, 10 - banditIssues - safetyIssues);
            
            const comment = `## ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼
            
            | ê²€ì‚¬ ë„êµ¬ | ë°œê²¬ëœ ì´ìŠˆ | ì‹¬ê°ë„ |
            | --------- | ----------- | ------ |
            | Bandit (ì½”ë“œ ë³´ì•ˆ) | ${banditIssues} | ${banditIssues > 5 ? 'ğŸ”´ ë†’ìŒ' : banditIssues > 0 ? 'ğŸŸ¡ ì¤‘ê°„' : 'ğŸŸ¢ ì—†ìŒ'} |
            | Safety (ì˜ì¡´ì„± ë³´ì•ˆ) | ${safetyIssues} | ${safetyIssues > 3 ? 'ğŸ”´ ë†’ìŒ' : safetyIssues > 0 ? 'ğŸŸ¡ ì¤‘ê°„' : 'ğŸŸ¢ ì—†ìŒ'} |
            | **ë³´ì•ˆ ì ìˆ˜** | ${securityScore}/10 | ${securityScore >= 8 ? 'ğŸŸ¢ ì•ˆì „' : securityScore >= 5 ? 'ğŸŸ¡ ì£¼ì˜' : 'ğŸ”´ ìœ„í—˜'} |
            
            ${banditIssues > 0 || safetyIssues > 0 ? '### ì£¼ìš” ë³´ì•ˆ ì´ìŠˆ\n\n' : '### ë³´ì•ˆ ì´ìŠˆ ì—†ìŒ âœ…\n\nì•ˆì „í•œ ì½”ë“œì…ë‹ˆë‹¤. ì¢‹ì€ ì‘ì—…ì…ë‹ˆë‹¤! ğŸ‘\n\n'}
            ${banditIssues > 0 ? '- Bandit ê²€ì‚¬ì—ì„œ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.\n' : ''}
            ${safetyIssues > 0 ? '- ì·¨ì•½í•œ ì˜ì¡´ì„±ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. íŒ¨í‚¤ì§€ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•´ ì£¼ì„¸ìš”.\n' : ''}
            
            ### ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
            - ì‚¬ìš©ì ì…ë ¥ ê²€ì¦
            - SQL ì¸ì ì…˜ ë°©ì§€ (ë§¤ê°œë³€ìˆ˜í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©)
            - ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (í•´ì‹± ì‚¬ìš©)
            - ì ì ˆí•œ ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…
            - ìµœì‹  ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©
            
            > ì´ ë³´ì•ˆ ê²€ì‚¬ëŠ” ìë™í™” ë„êµ¬ë¥¼ í†µí•´ ìƒì„±ë˜ì—ˆìœ¼ë©°, ëª¨ë“  ë³´ì•ˆ ì·¨ì•½ì ì„ ë°œê²¬í•˜ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: comment
            });

  test-coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
          
      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
        id: coverage
        run: |
          pytest --cov=src --cov=frontend --cov-report=xml --cov-report=term || true
          echo "total=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(root.attrib['line-rate'])")" >> $GITHUB_OUTPUT
          
      - name: ì»¤ë²„ë¦¬ì§€ ê²°ê³¼ ì½”ë©˜íŠ¸
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const repo = context.repo;
            
            // ì»¤ë²„ë¦¬ì§€ ê³„ì‚°
            let coverage = parseFloat('${{ steps.coverage.outputs.total }}') * 100 || 0;
            
            let coverageEmoji = '';
            if (coverage >= 80) {
              coverageEmoji = 'ğŸŸ¢';
            } else if (coverage >= 50) {
              coverageEmoji = 'ğŸŸ¡';
            } else {
              coverageEmoji = 'ğŸ”´';
            }
            
            const comment = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¶„ì„
            
            | ì§€í‘œ | ê²°ê³¼ | ìƒíƒœ |
            | ---- | ---- | ---- |
            | ë¼ì¸ ì»¤ë²„ë¦¬ì§€ | ${coverage.toFixed(2)}% | ${coverageEmoji} |
            | ëª©í‘œ ì»¤ë²„ë¦¬ì§€ | 80.00% | ${coverage >= 80 ? 'âœ…' : 'âŒ'} |
            
            ${coverage < 80 ? `### ê°œì„  í•„ìš” ì‚¬í•­\n\n- í˜„ì¬ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ëª©í‘œ(80%)ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤.\n- ì¤‘ìš” ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.\n- íŠ¹íˆ ë³µì¡í•œ ë¡œì§ê³¼ ì˜ˆì™¸ ì²˜ë¦¬ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.` : `### í›Œë¥­í•œ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ğŸ‘\n\nëª©í‘œ ì»¤ë²„ë¦¬ì§€ë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤! ì¢‹ì€ ì‘ì—…ì…ë‹ˆë‹¤.`}
            
            ### í…ŒìŠ¤íŠ¸ ëª¨ë²” ì‚¬ë¡€
            - ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
            - ì˜ˆì™¸ ìƒí™©ê³¼ ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
            - í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ì»´í¬ë„ŒíŠ¸ ê°„ ìƒí˜¸ì‘ìš© ê²€ì¦
            - í…ŒìŠ¤íŠ¸ëŠ” ë…ë¦½ì ì´ê³  ë°˜ë³µ ê°€ëŠ¥í•˜ê²Œ ì‘ì„±
            
            > í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ëŠ” ì½”ë“œ í’ˆì§ˆì˜ í•œ ì§€í‘œì¼ ë¿ì´ë©°, í…ŒìŠ¤íŠ¸ì˜ ì§ˆì ì¸ ë¶€ë¶„ë„ ì¤‘ìš”í•©ë‹ˆë‹¤.`;
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: comment
            }); 