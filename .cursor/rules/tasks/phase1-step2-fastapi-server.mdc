---
description:
globs:
alwaysApply: false
---
# 2ë‹¨ê³„: FastAPI ì„œë²„ ê¸°ë³¸ êµ¬ì¡° êµ¬í˜„

## ğŸ¯ ëª©í‘œ
API ì„œë²„ ê¸°ë°˜ êµ¬ì¶• ë° ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸ ê¸°ë³¸ êµ¬ì¡° êµ¬í˜„

## ğŸ“‹ ìƒì„¸ íƒœìŠ¤í¬

### 2.1 FastAPI ì„œë²„ ë©”ì¸ ì•± êµ¬ì„±

#### í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¥
```
src/api/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat.py
â”‚   â””â”€â”€ health.py
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat.py
â”‚   â””â”€â”€ response.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ streaming.py
â””â”€â”€ middleware/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ cors.py
```

#### ë©”ì¸ ì•± êµ¬ì„± (`src/api/main.py`)
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from contextlib import asynccontextmanager
import logging

from .routers import chat, health
from .middleware.cors import setup_cors

# ë¡œê¹… ì„¤ì •
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """ì•± ìƒëª…ì£¼ê¸° ê´€ë¦¬"""
    logger.info("PriceFinder Agent API ì‹œì‘")
    yield
    logger.info("PriceFinder Agent API ì¢…ë£Œ")

app = FastAPI(
    title="PriceFinder Agent API",
    description="ìµœì €ê°€ ì‡¼í•‘ Agent API - ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì§€ì›",
    version="0.1.0",
    lifespan=lifespan
)

# CORS ì„¤ì •
setup_cors(app)

# ë¼ìš°í„° ë“±ë¡
app.include_router(health.router, prefix="/api/v1", tags=["health"])
app.include_router(chat.router, prefix="/api/v1", tags=["chat"])

@app.get("/")
async def root():
    return {
        "message": "PriceFinder Agent API",
        "version": "0.1.0",
        "docs": "/docs"
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "src.api.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
```

### 2.2 `/chat` ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸ ê¸°ë³¸ êµ¬ì¡°

#### ì±„íŒ… ëª¨ë¸ ì •ì˜ (`src/api/models/chat.py`)
```python
from pydantic import BaseModel, Field
from typing import Optional, Literal
from datetime import datetime

class ChatRequest(BaseModel):
    """ì±„íŒ… ìš”ì²­ ëª¨ë¸"""
    message: str = Field(..., description="ì‚¬ìš©ì ë©”ì‹œì§€")
    session_id: str = Field(..., description="ì„¸ì…˜ ID")
    message_type: Literal["text", "image"] = Field(default="text", description="ë©”ì‹œì§€ íƒ€ì…")

class ChatImageRequest(BaseModel):
    """ì´ë¯¸ì§€ ì±„íŒ… ìš”ì²­ ëª¨ë¸"""
    message: str = Field(..., description="ì‚¬ìš©ì ë©”ì‹œì§€")
    session_id: str = Field(..., description="ì„¸ì…˜ ID")
    # ì´ë¯¸ì§€ëŠ” multipart/form-dataë¡œ ë³„ë„ ì²˜ë¦¬

class StreamEvent(BaseModel):
    """ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ ëª¨ë¸"""
    type: str = Field(..., description="ì´ë²¤íŠ¸ íƒ€ì…")
    data: dict = Field(default_factory=dict, description="ì´ë²¤íŠ¸ ë°ì´í„°")
    timestamp: datetime = Field(default_factory=datetime.now, description="íƒ€ì„ìŠ¤íƒ¬í”„")
    session_id: Optional[str] = Field(None, description="ì„¸ì…˜ ID")
```

#### ì‘ë‹µ ëª¨ë¸ ì •ì˜ (`src/api/models/response.py`)
```python
from pydantic import BaseModel, Field
from typing import List, Optional, Any
from datetime import datetime

class ProductInfo(BaseModel):
    """ìƒí’ˆ ì •ë³´ ëª¨ë¸"""
    id: str = Field(..., description="ìƒí’ˆ ID")
    name: str = Field(..., description="ìƒí’ˆëª…")
    image_url: Optional[str] = Field(None, description="ìƒí’ˆ ì´ë¯¸ì§€ URL")
    brand: Optional[str] = Field(None, description="ë¸Œëœë“œ")

class PriceInfo(BaseModel):
    """ê°€ê²© ì •ë³´ ëª¨ë¸"""
    shop_name: str = Field(..., description="ì‡¼í•‘ëª°ëª…")
    price: int = Field(..., description="ê°€ê²©")
    original_price: Optional[int] = Field(None, description="ì›ê°€")
    discount_rate: Optional[float] = Field(None, description="í• ì¸ìœ¨")
    shipping_fee: Optional[int] = Field(None, description="ë°°ì†¡ë¹„")
    url: str = Field(..., description="ìƒí’ˆ URL")

class SearchResult(BaseModel):
    """ê²€ìƒ‰ ê²°ê³¼ ëª¨ë¸"""
    product: ProductInfo
    prices: List[PriceInfo]
    lowest_price: PriceInfo
    timestamp: datetime = Field(default_factory=datetime.now)
```

#### ìŠ¤íŠ¸ë¦¬ë° ì„œë¹„ìŠ¤ (`src/api/services/streaming.py`)
```python
import asyncio
import json
from typing import AsyncGenerator, Dict, Any
from datetime import datetime

from ..models.chat import StreamEvent

class StreamingService:
    """ìŠ¤íŠ¸ë¦¬ë° ì„œë¹„ìŠ¤ í´ë˜ìŠ¤"""
    
    @staticmethod
    async def create_sse_response(event: StreamEvent) -> str:
        """Server-Sent Events í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ ìƒì„±"""
        data = {
            "type": event.type,
            "data": event.data,
            "timestamp": event.timestamp.isoformat(),
            "session_id": event.session_id
        }
        return f"data: {json.dumps(data, ensure_ascii=False)}\n\n"
    
    @staticmethod
    async def stream_chat_response(
        message: str, 
        session_id: str
    ) -> AsyncGenerator[str, None]:
        """ì±„íŒ… ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë°"""
        
        # ì‹œì‘ ì´ë²¤íŠ¸
        start_event = StreamEvent(
            type="start",
            data={"message": "ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤..."},
            session_id=session_id
        )
        yield await StreamingService.create_sse_response(start_event)
        
        # ì²˜ë¦¬ ì¤‘ ì´ë²¤íŠ¸ (ì‹œë®¬ë ˆì´ì…˜)
        processing_event = StreamEvent(
            type="processing",
            data={"message": f"'{message}'ë¥¼ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤..."},
            session_id=session_id
        )
        yield await StreamingService.create_sse_response(processing_event)
        
        # ì‹œë®¬ë ˆì´ì…˜ ì§€ì—°
        await asyncio.sleep(1)
        
        # ê²°ê³¼ ì´ë²¤íŠ¸ (ì„ì‹œ ë°ì´í„°)
        result_event = StreamEvent(
            type="result",
            data={
                "message": f"'{message}' ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                "products": [],  # TODO: ì‹¤ì œ ê²€ìƒ‰ ê²°ê³¼ë¡œ ëŒ€ì²´
                "note": "ì‹¤ì œ ê²€ìƒ‰ ê¸°ëŠ¥ì€ 3ë‹¨ê³„ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤."
            },
            session_id=session_id
        )
        yield await StreamingService.create_sse_response(result_event)
        
        # ì™„ë£Œ ì´ë²¤íŠ¸
        complete_event = StreamEvent(
            type="complete",
            data={"message": "ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."},
            session_id=session_id
        )
        yield await StreamingService.create_sse_response(complete_event)
```

#### ì±„íŒ… ë¼ìš°í„° (`src/api/routers/chat.py`)
```python
from fastapi import APIRouter, HTTPException, File, UploadFile, Form
from fastapi.responses import StreamingResponse
from typing import Optional
import uuid

from ..models.chat import ChatRequest
from ..services.streaming import StreamingService

router = APIRouter()

@router.post("/chat")
async def chat_stream(request: ChatRequest):
    """í…ìŠ¤íŠ¸ ì±„íŒ… ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸"""
    try:
        return StreamingResponse(
            StreamingService.stream_chat_response(
                message=request.message,
                session_id=request.session_id
            ),
            media_type="text/event-stream",
            headers={
                "Cache-Control": "no-cache",
                "Connection": "keep-alive",
                "Access-Control-Allow-Origin": "*",
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/chat/image")
async def chat_image_stream(
    message: str = Form(...),
    session_id: str = Form(...),
    image: UploadFile = File(...)
):
    """ì´ë¯¸ì§€ ì±„íŒ… ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸"""
    try:
        # TODO: ì´ë¯¸ì§€ ì²˜ë¦¬ ë¡œì§ êµ¬í˜„ (7ë‹¨ê³„ì—ì„œ)
        return StreamingResponse(
            StreamingService.stream_chat_response(
                message=f"[ì´ë¯¸ì§€] {message}",
                session_id=session_id
            ),
            media_type="text/event-stream",
            headers={
                "Cache-Control": "no-cache",
                "Connection": "keep-alive",
                "Access-Control-Allow-Origin": "*",
            }
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/chat/session")
async def create_session():
    """ìƒˆ ì±„íŒ… ì„¸ì…˜ ìƒì„±"""
    session_id = str(uuid.uuid4())
    return {"session_id": session_id}
```

#### í—¬ìŠ¤ì²´í¬ ë¼ìš°í„° (`src/api/routers/health.py`)
```python
from fastapi import APIRouter
from datetime import datetime

router = APIRouter()

@router.get("/health")
async def health_check():
    """ì„œë²„ ìƒíƒœ í™•ì¸"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "PriceFinder Agent API"
    }

@router.get("/health/detailed")
async def detailed_health_check():
    """ìƒì„¸ ì„œë²„ ìƒíƒœ í™•ì¸"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "PriceFinder Agent API",
        "version": "0.1.0",
        "components": {
            "api": "healthy",
            "streaming": "healthy",
            "agent": "not_implemented",  # 3ë‹¨ê³„ì—ì„œ êµ¬í˜„
            "mcp": "not_implemented"     # 4ë‹¨ê³„ì—ì„œ êµ¬í˜„
        }
    }
```

#### CORS ë¯¸ë“¤ì›¨ì–´ (`src/api/middleware/cors.py`)
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

def setup_cors(app: FastAPI):
    """CORS ì„¤ì •"""
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # ê°œë°œ í™˜ê²½ìš©, í”„ë¡œë•ì…˜ì—ì„œëŠ” ì œí•œ í•„ìš”
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
```

### 2.3 í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±

#### API í…ŒìŠ¤íŠ¸ (`tests/test_api/test_main.py`)
```python
import pytest
from fastapi.testclient import TestClient
from src.api.main import app

client = TestClient(app)

def test_root():
    """ë£¨íŠ¸ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸"""
    response = client.get("/")
    assert response.status_code == 200
    assert "PriceFinder Agent API" in response.json()["message"]

def test_health_check():
    """í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸"""
    response = client.get("/api/v1/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_create_session():
    """ì„¸ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸"""
    response = client.get("/api/v1/chat/session")
    assert response.status_code == 200
    assert "session_id" in response.json()
```

#### ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸ (`tests/test_api/test_streaming.py`)
```python
import pytest
from fastapi.testclient import TestClient
from src.api.main import app

client = TestClient(app)

def test_chat_stream():
    """ì±„íŒ… ìŠ¤íŠ¸ë¦¬ë° í…ŒìŠ¤íŠ¸"""
    response = client.post(
        "/api/v1/chat",
        json={
            "message": "ì•„ì´í° 15 ìµœì €ê°€",
            "session_id": "test-session"
        }
    )
    assert response.status_code == 200
    assert response.headers["content-type"] == "text/event-stream; charset=utf-8"
```

### 2.4 ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸

#### ê°œë°œ ì„œë²„ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (`scripts/run_api.py`)
```python
#!/usr/bin/env python3
import uvicorn
import os
from pathlib import Path

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
project_root = Path(__file__).parent.parent
os.sys.path.insert(0, str(project_root))

if __name__ == "__main__":
    uvicorn.run(
        "src.api.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
```

## âœ… ì™„ë£Œ ê¸°ì¤€
- [ ] FastAPI ì„œë²„ ë©”ì¸ ì•± êµ¬ì„± ì™„ë£Œ
- [ ] ë¼ìš°í„° êµ¬ì¡° ì„¤ì • (chat, health)
- [ ] ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸ ê¸°ë³¸ êµ¬ì¡° êµ¬í˜„
- [ ] Pydantic ëª¨ë¸ ì •ì˜ (ìš”ì²­/ì‘ë‹µ)
- [ ] Server-Sent Events ìŠ¤íŠ¸ë¦¬ë° ì„œë¹„ìŠ¤ êµ¬í˜„
- [ ] CORS ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
- [ ] ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
- [ ] API ì„œë²„ ì‹¤í–‰ í™•ì¸ (http://localhost:8000)
- [ ] API ë¬¸ì„œ í™•ì¸ (http://localhost:8000/docs)
- [ ] ìŠ¤íŠ¸ë¦¬ë° ì—”ë“œí¬ì¸íŠ¸ ë™ì‘ í™•ì¸

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ì„œë²„ ì‹¤í–‰
```bash
python scripts/run_api.py
```

### 2. API í…ŒìŠ¤íŠ¸
```bash
# í—¬ìŠ¤ì²´í¬
curl http://localhost:8000/api/v1/health

# ì„¸ì…˜ ìƒì„±
curl http://localhost:8000/api/v1/chat/session

# ì±„íŒ… ìŠ¤íŠ¸ë¦¬ë° (í„°ë¯¸ë„ì—ì„œ)
curl -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ì•„ì´í° 15 ìµœì €ê°€", "session_id": "test-session"}'
```

### 3. ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
pytest tests/test_api/ -v
```

## ğŸ”— ë‹¤ìŒ ë‹¨ê³„
[Phase 1 Step 3 - LangGraph Agent ê¸°ë³¸ ì›Œí¬í”Œë¡œìš° êµ¬í˜„](mdc:.cursor/rules/tasks/phase1-step3-langgraph-agent.mdc)

## ğŸ“š ì°¸ê³  ë¬¸ì„œ
- [ê°œë°œ íƒœìŠ¤í¬ ê³„íš](mdc:.cursor/rules/development-task-plan.mdc)
- [API ëª…ì„¸ì„œ](mdc:.cursor/rules/api-specification.mdc)
- [ê¸°ìˆ  ì•„í‚¤í…ì²˜](mdc:.cursor/rules/technical-architecture.mdc)
